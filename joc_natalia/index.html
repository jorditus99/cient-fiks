<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El laberint de clavegueres</title>
</head>
<body>
    <div id="background">
        <!-- <img class="imatge_joc" src="/img/img_natalia/grass_bg.png" > -->

        <div class="table-container">
            <table>
                <!-- here is where the map generates -->
            </table>
        </div>

        <button id = 'one' type="button" name="Click to Play" onClick = 'loadPage();'>Jugar!</button>
    </div>
    <style>

        html,body {
            height: 100%; /* Use full viewport height */
            margin: 0; /* Remove default margin */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            background-image: url("/img/river_night.gif");
            background-size: cover;
            background-position: center;
        }

        #background {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }

        .table-container {
            height: 90%;
            width: 70%;
            margin: 0 auto;
            display: flex;
            justify-content: center; /* Center the table */
            align-items: center; /* Align items center */
            border-radius: 1rem;
            background-color: black;
        }

        table {
            margin-top: 50px;
        }

        .fons {

            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            
        }

        .imatge_joc {
            size: 100%;
            border-radius: 1rem;
            
        }

        
        /* #################################################### */

        #player {
            position: absolute;
            width: 1.2rem;
            height: 1.6rem;
            background-color: rgb(31, 221, 255);
            color: rgb(31, 221, 255);
            z-index: 2;
        }


        table {
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            width: auto;
            height: auto;
            border-spacing: 0px;
            border-collapse: initial;
            position: absolute;
        }

        tr {
            border: none;
        }

        /*table element styles*/
        td {
            width: 1.9rem;
            height: 1.9rem;
            margin: 0px;
            border: none;
            padding: 0px;
        }

        #win {
            background-color: rgb(163, 255, 183);
            color:rgb(163, 255, 183);
        }

        .wall {
            color: rgba(255, 255, 255, 0);
            /* background-image: url("../img/img_natalia/wall.jpg"); */
            background-color: rgb(40, 25, 94);
        }

        .freespace {
            color:rgb(41, 128, 87);
            background-color: rgb(41, 128, 87);
        }

        #start {
            color:rgb(247, 255, 176);
            background-color: rgb(247, 255, 176);
        }

        .key {
            color:rgb(255, 158, 247);
            background-color: rgb(255, 158, 247);
        }

    </style>


    <script>

        let maze = [
            `#_#######################################`, //index 2
            `#.#.....?..#........#.....#.......#.....#`,
            `#.####....?####.#####.###.###.#.#######.#`,
            `#?....?###....#.........#.....#.#.......#`,
            `###.####.###.##.#########.###.###.#######`,
            `#...#.....#.....#.......#.#.............#`,
            `#.###.###.#.###########.###########.#####`,
            `#...#.#.#.#.#..#...#..........#.........#`,
            `###.#.#.#......#.....#.########.#######.#`,
            `#...#.#.########...#.#........#.......#.#`,
            `#.#.#...#......#####.######.#.#.#####...#`,
            `#.#.###.#####...#.........#.#...#.#.#...#`,
            `#.#...#.....#.#.#.#######.#.#####.#.....#`,
            `#.#########.#.#.#.......#.#.......#.##.##`,
            `#........#....#.####.######.#####...#...#`,
            `#####.###########.........#.#...#####.###`,
            `#.#...#...........###########.#.#.......#`,
            `#.###.#.######.##.#.....#.#...###.#######`,
            `#...#.#.#....#.#..#.#####.#.#.#.#.#.....#`,
            `###.###.#.####.#.##.#...#.#.#.#.#.#.###.#`,
            `#.......#......#.#..#.#.#...#.........#.#`,
            `#.#...#####.####.#.##.#.###.####.######.#`,
            `#.#..........#........#........#.#......#`,
            `################################!########`
            
        ];

        // GLOBAL VARIABLES
        let currentLevel = maze;
        let body = document.querySelector('body');
        let tableDiv = document.getElementById('background');
        let table = document.querySelector('table');
        

        // Variable to track if player is on a key tile
        let isOnKeyTile = false;
        let keyTile = null;
        let originalColor = 'rgb(255, 158, 247)'; // Original key color
        let keyStates = new Map(); // To track the activation state of each key tile
        let totalKeyTiles = 0; // Total number of key tiles
        let activatedKeyTiles = 0; // Number of activated key tiles

        // DRAWING OF MAZE
        let loadPage = () => {
            let mover = document.createElement('div');

            const drawMaze = (maze) => {
                tableDiv.appendChild(mover);

                mover.style.left = '18%';
                mover.style.top = '15%';
                mover.setAttribute('id', 'player');
                mover.textContent = '@';

                for (let i = 0; i < currentLevel.length; i++) {
                    let row = document.createElement('tr');
                    table.appendChild(row);

                    for (let x = 0; x < currentLevel[i].length; x++) {
                        let tableD = document.createElement('td');
                        row.appendChild(tableD);

                        tableD.innerHTML = maze[i].charAt(x);

                        switch (maze[i].charAt(x)) {
                            case '#':
                                tableD.setAttribute('class', 'wall');
                                break;
                            case '.':
                                tableD.setAttribute('class', 'freespace');
                                break;
                            case '_':
                                tableD.setAttribute('id', 'start');
                                break;
                            case '!':
                                tableD.setAttribute('id', 'win');
                                break;
                            case '?':
                                tableD.setAttribute('class', 'key');
                                totalKeyTiles++; // Count the total key tiles
                                keyStates.set(tableD, false); // Initialize key state as inactive
                                break;
                        }
                    }
                }
            };

            drawMaze(currentLevel);

            // Move player and check for collisions
            window.addEventListener('keydown', (event) => {
                let pos = mover.getBoundingClientRect();
                let newPos = { left: pos.left, top: pos.top };

                // Update position based on arrow keys
                switch (event.key) {
                    case 'ArrowUp':
                        newPos.top -= 5;
                        break;
                    case 'ArrowDown':
                        newPos.top += 5;
                        break;
                    case 'ArrowLeft':
                        newPos.left -= 5;
                        break;
                    case 'ArrowRight':
                        newPos.left += 5;
                        break;
                }

                // Check collision with walls
                let collides = false;
                let impassableTiles = document.querySelectorAll('.wall');

                for (let tile of impassableTiles) {
                    let tileRect = tile.getBoundingClientRect();
                    if (newPos.left < tileRect.right && newPos.left + pos.width > tileRect.left &&
                        newPos.top < tileRect.bottom && newPos.top + pos.height > tileRect.top) {
                        collides = true;
                        break;
                    }
                }

                // Move player only if no collision
                if (!collides) {
                    mover.style.left = newPos.left + 'px';
                    mover.style.top = newPos.top + 'px';
                }

                // Check if player is on a key tile
                let keyTiles = document.querySelectorAll('.key');
                isOnKeyTile = false;
                keyTile = null;

                for (let key of keyTiles) {
                    let keyRect = key.getBoundingClientRect();
                    if (newPos.left < keyRect.right && newPos.left + pos.width > keyRect.left &&
                        newPos.top < keyRect.bottom && newPos.top + pos.height > keyRect.top) {
                        isOnKeyTile = true;
                        keyTile = key;  // Store the reference to the key tile
                        break;  // Exit the loop since we found a key tile
                    }
                }
            });

            // Event listener for "X" key
            window.addEventListener('keydown', (event) => {
                if (event.key.toLowerCase() === 'x') {  // Convert to lowercase for consistency
                    if (isOnKeyTile && keyTile) {
                        // Toggle the key tile's color
                        if (keyStates.get(keyTile)) {
                            keyTile.style.backgroundColor = originalColor; // Reset to original color
                            keyTile.style.color = originalColor; // Reset text color (if applicable)
                            keyStates.set(keyTile, false); // Set the key state to inactive
                            activatedKeyTiles--; // Decrease the count of activated keys
                        } else {
                            //Se activa una llave
                            keyTile.style.backgroundColor = 'blue'; // Change color to blue
                            keyStates.set(keyTile, true); // Set the key state to active
                            activatedKeyTiles++; // Increase the count of activated keys
                        }

                        // Check if all key tiles are activated
                        let winTile = document.getElementById('win');

                        // Determine if all keys are active (blue)
                        let allKeysActive = true;
                        for (let [key, isActive] of keyStates) {
                            if (!isActive) { // If any key is inactive
                                allKeysActive = false;
                                break;
                            }
                        }

                        // Update the win tile color based on the keys' state
                        if (allKeysActive) {
                            winTile.style.backgroundColor = 'gold'; // Change win tile color to gold
                        } else {
                            winTile.style.backgroundColor = ''; // Reset win tile color to default
                        }
                    } else {
                        console.log("No est√°s en una llave"); // Debug message
                    }
                }
            });

        };

        loadPage();  // Ensure to call the function to load the page






    </script>

</body>
</html>