<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El laberint de clavegueres</title>
</head>
<body>
    <div id="background">
        <!-- <img class="imatge_joc" src="/img/img_natalia/grass_bg.png" > -->
        <table>

        </table>

        <button id = 'one' type="button" name="Click to Play" onClick = 'loadPage();'>Jugar!</button>
    </div>
    <style>

        html,body {
            height: 100%;
            margin: 0;
            font-family: "Pixelify Sans", sans-serif;
            background-image: url("/img/river_night.gif");
            background-size: cover;
            background-position: center;
        }

        .fons {

            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            
        }

        .imatge_joc {
            size: 100%;
            border-radius: 1rem;
            
        }

        
        /* #################################################### */

        #player {
            position: absolute;
            width: 20px;
            height: 20px;
            display: block;
            background-color: black;
            color: black;
            z-index: 10000;
        }


        table {
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            width: auto;
            height: auto;
            border-spacing: 0px;
            border-collapse: initial;
            position: absolute;
        }

        div#background {
            position: none;
        }

        tr {
            border: none;
        }
        /*table element styles*/
        td {
            width: 35px;
            height: 35px;
            margin: 0px;
            border: none;
            padding: 0px;
        }

        #win {
            background-color: rgb(163, 255, 183);
            color:rgb(163, 255, 183);
        }

        .wall {
            color: rgba(255, 255, 255, 0);
            /* background-image: url("../img/img_natalia/wall.jpg"); */
            background-color: rgb(40, 25, 94);
        }

        .freespace {
            color:rgb(41, 128, 87);
            background-color: rgb(41, 128, 87);
        }

        #start {
            color:rgb(247, 255, 176);
            background-color: rgb(247, 255, 176);
        }

        .key {
            color:rgb(255, 158, 247);
            background-color: rgb(255, 158, 247);
        }

    </style>


    <script>

        let maze = [
            `#.#######################################`, //index 2
            `#.#.....?..#........#.....#.......#.....#`,
            `#.####.###.####.#####.###.###.#.#######.#`,
            `#......#.#....#.........#.....#.#.......#`,
            `###.####.###.##.#########.###.###.#######`,
            `#...#.....#.....#.......#.#.............#`,
            `#.###.###.#.###########.###########.#####`,
            `#...#.#.#.#.#..#.?.#..........#.........#`,
            `###.#.#.#......#.....#.########.#######.#`,
            `#...#.#.########...#.#........#.......#.#`,
            `#.#.#...#......#####.######.#.#.#####...#`,
            `#.#.###.#####...#.........#.#...#...#..?#`,
            `#.#...#.....#.#.#.#######...#####.###...#`,
            `#.#########.#.#.#.......#...........###.#`,
            `#........#....#.####.#########..........#`,
            `#####.###########...........#...........#`,
            `#.#...#...........#################.#####`,
            `#.###.#.######.##.#.....#.......#.......#`,
            `#...#.#.#....#.#..#.#####...#...#######.#`,
            `###.###.#.####.#.##.#...#...#.......#.#.#`,
            `#.......#......#.#..#.#.#...#....#..#.#.#`,
            `#.#...#####.####.#.##.#.###..#...#...#.##`,
            `#.#.?........#........#........#.#......#`,
            `################################!########`
            
        ];

        // GLOBAL VARIABLES
        let currentLevel = maze;
        let body = document.querySelector('body');
        let tableDiv = document.getElementById('background');
        let table = document.querySelector('table');


        // DRAWING OF MAZE
        let loadPage = () => {

            let mover = document.createElement('div');

            const drawMaze = (maze) => {
                tableDiv.appendChild(mover);

                mover.style.left = '45px';
                mover.style.top = '10px';
                mover.setAttribute('id', 'player');
                mover.textContent = '@';

                for (let i = 0; i < currentLevel.length; i++) {
                    let row = document.createElement('tr');
                    table.appendChild(row);

                    for (let x = 0; x < currentLevel[i].length; x++) {
                        let tableD = document.createElement('td');
                        row.appendChild(tableD);

                        tableD.innerHTML = maze[i].charAt(x);

                        switch (maze[i].charAt(x)) {
                            case '#':
                                tableD.setAttribute('class', 'wall');
                                break;
                            case '.':
                                tableD.setAttribute('class', 'freespace');
                                break;
                            case '_':
                                tableD.setAttribute('id', 'start');
                                break;
                            case '!':
                                tableD.setAttribute('id', 'win');
                                break;

                            case '?':
                                tableD.setAttribute('class', 'key');
                                break;
                        }
                    }
                }
            }

            drawMaze(currentLevel);

            window.addEventListener('keydown', event => {
                let pos = mover.getBoundingClientRect();
                let newPos = { left: pos.left, top: pos.top };

                // Update new position based on arrow keys
                switch (event.key) {
                    case 'ArrowUp':
                        newPos.top -= 5;
                        break;
                    case 'ArrowDown':
                        newPos.top += 5;
                        break;
                    case 'ArrowLeft':
                        newPos.left -= 5;
                        break;
                    case 'ArrowRight':
                        newPos.left += 5;
                        break;
                }

                // Check collision with walls
                let collides = false;
                let impassableTiles = document.querySelectorAll('.wall, .key');

                for (let tile of impassableTiles) {
                    let tileRect = tile.getBoundingClientRect();
                    if (newPos.left < tileRect.right && newPos.left + pos.width > tileRect.left &&
                        newPos.top < tileRect.bottom && newPos.top + pos.height > tileRect.top) {
                        collides = true;
                        break;
                    }
                }

                // Move the player only if there is no collision
                if (!collides) {
                    mover.style.left = newPos.left + 'px';
                    mover.style.top = newPos.top + 'px';
                }

                // Display alert if player reaches a key
                let keyTiles = document.querySelectorAll('.key');
                for (let key of keyTiles) {
                    let keyRect = key.getBoundingClientRect();
                    if (newPos.left < keyRect.right && newPos.left + pos.width > keyRect.left &&
                        newPos.top < keyRect.bottom && newPos.top + pos.height > keyRect.top) {
                        alert("Has llegado a una llave!");
                        break;
                    }
                }
                
            });
        }

        
        

    </script>

</body>
</html>